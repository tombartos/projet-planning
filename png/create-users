#!/bin/sh

PROF=tbaron132
STUDENT=llaurent704
RESP=dupont888

psql 'postgres://postgres:mysecretpassword@localhost:8080/' <<EOF

CREATE USER $STUDENT WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE postgres TO $STUDENT;
GRANT USAGE ON SCHEMA public TO $STUDENT;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO $STUDENT;
GRANT USAGE, SELECT ON SEQUENCE public."note_perso_sequence" TO $STUDENT;
GRANT INSERT ON TABLE notes_perso TO $STUDENT;
GRANT UPDATE ON TABLE notes_perso TO $STUDENT;


CREATE USER $PROF WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE postgres TO $PROF;
GRANT USAGE ON SCHEMA public TO $PROF;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO $PROF;
GRANT INSERT ON ALL TABLES IN SCHEMA public TO $PROF;
GRANT UPDATE ON ALL TABLES IN SCHEMA public TO $PROF;
GRANT DELETE ON ALL TABLES IN SCHEMA public TO $PROF;
GRANT USAGE, SELECT ON SEQUENCE public."note_perso_sequence" TO $PROF;
GRANT INSERT ON TABLE notes_perso TO $PROF;
GRANT UPDATE ON TABLE notes_perso TO $PROF;
GRANT USAGE, SELECT ON SEQUENCE public."demande_creneau_sequence" TO $PROF;
GRANT INSERT ON TABLE demandes_creneaux TO $PROF;
GRANT UPDATE ON TABLE demandes_creneaux TO $PROF;



CREATE USER $RESP WITH PASSWORD 'password';
GRANT CONNECT ON DATABASE postgres TO $RESP;
GRANT USAGE ON SCHEMA public TO $RESP;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO $RESP;
GRANT INSERT ON ALL TABLES IN SCHEMA public TO $RESP;
GRANT UPDATE ON ALL TABLES IN SCHEMA public TO $RESP;
GRANT DELETE ON ALL TABLES IN SCHEMA public TO $RESP;

GRANT USAGE, SELECT ON SEQUENCE public."demande_creneau_sequence" TO $RESP;
GRANT INSERT ON TABLE demandes_creneaux TO $RESP;
GRANT UPDATE ON TABLE demandes_creneaux TO $RESP;
DO \$\$
BEGIN
    EXECUTE (
        SELECT string_agg(
            format('GRANT USAGE, SELECT, UPDATE ON SEQUENCE %I.%I TO $RESP;', schemaname, sequencename),
            ' '
        )
        FROM pg_sequences
        WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
    );
END \$\$;


EOF
